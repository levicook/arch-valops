#!/bin/bash
#
# validator-up - Start validator process
#
# Ensures validator process is running and healthy:
# - Starts validator if not already running
# - Verifies validator health and RPC connectivity
# - Reports status and provides monitoring guidance
#
# Usage:
#   validator-up --user <validator-username>
#
# What it does:
# - Checks if validator process is already running
# - Starts validator process if needed
# - Waits for startup and verifies health
# - Reports final status
#
# Dependencies: Run 'validator-init' first for complete setup
#
set -euo pipefail
source "$(dirname "$0")/common.sh"
cd "$PROJECT_ROOT"

log_echo() {
    echo "validator-up: $@"
}

# Parse command line arguments
VALIDATOR_USER=""

while [[ $# -gt 0 ]]; do
    case $1 in
    --user)
        VALIDATOR_USER="$2"
        shift 2
        ;;
    -h | --help)
        echo "Usage: validator-up --user <validator-username>"
        echo ""
        echo "Options:"
        echo "  --user <username>                Validator user to start"
        echo "  -h, --help                       Show this help"
        echo ""
        echo "Examples:"
        echo "  validator-up --user testnet-validator"
        exit 0
        ;;
    *)
        echo "validator-up: Unknown option: $1"
        echo "validator-up: Use --help for usage information"
        exit 1
        ;;
    esac
done

# Validate arguments
if [[ -z "$VALIDATOR_USER" ]]; then
    log_echo "ERROR: --user is required"
    echo "Usage: validator-up --user <validator-username>"
    exit 1
fi

# Check prerequisites
if ! id "$VALIDATOR_USER" &>/dev/null; then
    log_echo "✗ User '$VALIDATOR_USER' not found. Run: ./validator-init first"
    exit 1
fi

if ! sudo -u "$VALIDATOR_USER" test -f "/home/$VALIDATOR_USER/run-validator"; then
    log_echo "✗ Not initialized. Run: ./validator-init first"
    exit 1
fi

# Update configuration and start validator
update_validator_operator "$VALIDATOR_USER"
sudo su - "$VALIDATOR_USER" -c "nohup ./run-validator > /dev/null 2>&1 &"
log_echo "✓ Validator started"
