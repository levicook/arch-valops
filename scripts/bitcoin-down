#!/bin/bash
#
# bitcoin-down - Stop Bitcoin Core daemon
#
# Ensures Bitcoin Core daemon is stopped:
# - Stops bitcoin daemon if running
# - Optional complete removal with --clobber
# - Reports status
#
# Usage:
#   # Environment variable (recommended):
#   BITCOIN_USER=testnet-bitcoin bitcoin-down
#
#   # Or traditional flag (backward compatibility):
#   bitcoin-down --user testnet-bitcoin
#
#   # Complete removal (with safety checks):
#   bitcoin-down --user testnet-bitcoin --clobber
#
# What it does:
# - Stops bitcoin daemon process if running
# - With --clobber: completely removes bitcoin user and data
# - Reports final status
#
set -euo pipefail
source "$(dirname "$0")/bitcoin-lib.sh"

log_echo() {
    echo "bitcoin-down: $@"
}

# Initialize from environment variable (can be overridden by flag)
BITCOIN_USER="${BITCOIN_USER:-}"
CLOBBER=false

# Parse command line arguments (override environment variable)
while [[ $# -gt 0 ]]; do
    case $1 in
    --user)
        BITCOIN_USER="$2"
        shift 2
        ;;
    --clobber)
        CLOBBER=true
        shift
        ;;
    -h | --help)
        echo "Usage: bitcoin-down [options]"
        echo ""
        echo "Environment Variable (recommended):"
        echo "  BITCOIN_USER                     Bitcoin user to stop"
        echo ""
        echo "Options (override environment variable):"
        echo "  --user <username>                Bitcoin user to stop"
        echo "  --clobber                        Complete removal (user and data)"
        echo "  -h, --help                       Show this help"
        echo ""
        echo "Examples:"
        echo "  # Using environment variable (recommended):"
        echo "  BITCOIN_USER=testnet-bitcoin bitcoin-down"
        echo ""
        echo "  # Using flag (backward compatibility):"
        echo "  bitcoin-down --user testnet-bitcoin"
        echo ""
        echo "  # Complete removal:"
        echo "  bitcoin-down --user testnet-bitcoin --clobber"
        exit 0
        ;;
    *)
        echo "bitcoin-down: Unknown option: $1"
        echo "bitcoin-down: Use --help for usage information"
        exit 1
        ;;
    esac
done

# Validate arguments
if [[ -z "$BITCOIN_USER" ]]; then
    log_echo "ERROR: BITCOIN_USER environment variable or --user flag is required"
    echo "Usage: BITCOIN_USER=testnet-bitcoin bitcoin-down"
    echo "   or: bitcoin-down --user testnet-bitcoin"
    exit 1
fi

# Check if user exists
if ! id "$BITCOIN_USER" &>/dev/null; then
    if [[ "$CLOBBER" == "true" ]]; then
        log_echo "✓ User '$BITCOIN_USER' already removed"
        exit 0
    else
        log_echo "✓ User '$BITCOIN_USER' not found (nothing to stop)"
        exit 0
    fi
fi

if [[ "$CLOBBER" == "true" ]]; then
    # Complete removal
    log_echo "⚠ CLOBBER MODE: Complete removal of bitcoin operator"
    log_echo "  User: $BITCOIN_USER"
    log_echo "  This will remove the user and all data permanently"

    read -p "Are you sure? (yes/no): " confirmation
    case "$confirmation" in
    yes|YES)
        log_echo "Proceeding with complete removal..."
        clobber_bitcoin_operator "$BITCOIN_USER"
        log_echo "✓ Bitcoin operator completely removed"
        ;;
    *)
        log_echo "Operation cancelled"
        exit 1
        ;;
    esac
else
    # Just stop the daemon
    stop_bitcoin "$BITCOIN_USER"
fi
