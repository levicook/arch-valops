#!/bin/bash
set -euo pipefail

# Ensure we're running from the user's home directory
cd "$HOME"

# Configuration with defaults (can be overridden by environment)
export DATA_DIR="${ARCH_DATA_DIR:-$HOME/data/.arch_data}"
export RPC_BIND_IP="${ARCH_RPC_BIND_IP:-127.0.0.1}"
export RPC_BIND_PORT="${ARCH_RPC_BIND_PORT:-9002}"
export TITAN_ENDPOINT="${ARCH_TITAN_ENDPOINT:-https://titan-public-http.test.arch.network}"
export TITAN_SOCKET_ENDPOINT="${ARCH_TITAN_SOCKET_ENDPOINT:-titan-public-tcp.test.arch.network:3030}"
export NETWORK_MODE="${ARCH_NETWORK_MODE:-testnet}"

# Disable OpenTelemetry completely
export OTEL_SDK_DISABLED=true
export OTEL_TRACES_EXPORTER=none
export OTEL_METRICS_EXPORTER=none
export OTEL_LOGS_EXPORTER=none

# Log file for all output
LOG_FILE="$HOME/logs/validator.log"

# Function to log and echo
log_echo() {
    echo "run-validator: $@" | tee -a "$LOG_FILE"
}

# Verify environment is set up correctly
if [[ ! -d "$DATA_DIR" ]]; then
    log_echo "ERROR: Data directory $DATA_DIR does not exist. Run validator-init first."
    exit 1
fi

if [[ ! -d "$HOME/logs" ]]; then
    log_echo "ERROR: Logs directory $HOME/logs does not exist. Run validator-init first."
    exit 1
fi

# Log startup with configuration
log_echo "$(date): Starting Arch validator..."
log_echo "Configuration:"
log_echo "  Data directory: $DATA_DIR"
log_echo "  RPC bind: $RPC_BIND_IP:$RPC_BIND_PORT"
log_echo "  Network mode: $NETWORK_MODE"
log_echo "  Titan endpoint: $TITAN_ENDPOINT"
log_echo "  Titan socket: $TITAN_SOCKET_ENDPOINT"

exec validator \
    --network-mode "$NETWORK_MODE" \
    --data-dir "$DATA_DIR" \
    --rpc-bind-ip "$RPC_BIND_IP" \
    --rpc-bind-port "$RPC_BIND_PORT" \
    --titan-endpoint "$TITAN_ENDPOINT" \
    --titan-socket-endpoint "$TITAN_SOCKET_ENDPOINT" \
    --disable-telemetry \
    "$@" >> "$LOG_FILE" 2>&1
